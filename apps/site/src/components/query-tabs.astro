---
import { Code, TabItem, Tabs } from '@astrojs/starlight/components';
import * as graphql from 'prettier/plugins/graphql';
import { format } from 'prettier/standalone';
import type { GraphqlDataResponse } from '../utils/schema';
import QueryGraph from './query-graph.vue';

type GraphqlResponse =
	| {
			data: GraphqlDataResponse;
	  }
	| { errors: { message: string }[] };

interface Props {
	query: string;
	variables?: string;
}

const { query, variables } = Astro.props;

const response = await fetch(
	`${import.meta.env.POLITIGRAPH_URL ?? 'https://politigraph.wevis.info'}/graphql`,
	{
		method: 'POST',
		headers: {
			'Content-Type': 'application/json',
		},
		body: JSON.stringify({
			// insert __typename field in every object that have an id
			query: query.replaceAll(' id ', ' __typename id '),
			variables: variables ? JSON.parse(variables) : {},
		}),
	},
);

if (!response.ok) {
	throw new Error(response.statusText);
}

const jsonResponse: GraphqlResponse = await response.json();

if ('errors' in jsonResponse) {
	throw new Error(jsonResponse.errors.map((e) => e.message).join('\n'));
}

const formattedQuery = await format(query, {
	parser: 'graphql',
	plugins: [graphql],
});

function formatJson(obj: Object) {
	return JSON.stringify(obj, null, 2);
}
---

<Tabs>
	<TabItem label="Visualization">
		<QueryGraph client:visible data={jsonResponse.data} />
	</TabItem>
	<TabItem label="Query">
		<Code
			code={formattedQuery}
			lang="graphql"
			class="md:h-128 overflow-y-auto"
		/>
	</TabItem>
	{
		variables && (
			<TabItem label="Variables">
				<Code
					code={formatJson(JSON.parse(variables))}
					lang="json"
					class="md:h-128 overflow-y-auto"
				/>
			</TabItem>
		)
	}
	<TabItem label="Response">
		<Code
			code={formatJson(jsonResponse)}
			lang="json"
			class="md:h-128 overflow-y-auto"
		/>
	</TabItem>
</Tabs>
